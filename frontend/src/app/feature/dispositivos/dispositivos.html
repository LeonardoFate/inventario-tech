<div class="dispositivos-container">
  <div class="header">
    <h1>Gesti贸n de Dispositivos</h1>
    <button *ngIf="esTecnicoOSuperior" (click)="nuevoDispositivo()" class="btn btn-primary">
      Nuevo Dispositivo
    </button>
  </div>

  <!-- Filtros -->
  <div class="filtros">
    <div class="filtros-row">
      <div class="filtro-group">
        <label>Buscar:</label>
        <input type="text" [(ngModel)]="filtros.buscar" placeholder="Nombre, c贸digo, serie, modelo..." 
               (keyup.enter)="aplicarFiltros()">
      </div>

      <div class="filtro-group">
        <label>Categor铆a:</label>
        <select [(ngModel)]="filtros.categoria">
          <option value="">Todas</option>
          <option *ngFor="let cat of categorias" [value]="cat.CategoriaID || cat.categoriaID">
            {{ cat.NombreCategoria || cat.nombreCategoria }}
          </option>
        </select>
      </div>

      <div class="filtro-group">
        <label>Marca:</label>
        <select [(ngModel)]="filtros.marca">
          <option value="">Todas</option>
          <option *ngFor="let marca of marcas" [value]="marca.MarcaID || marca.marcaID">
            {{ marca.NombreMarca || marca.nombreMarca }}
          </option>
        </select>
      </div>

      <div class="filtro-group">
        <label>Estado:</label>
        <select [(ngModel)]="filtros.estado">
          <option value="">Todos</option>
          <option *ngFor="let estado of estados" [value]="estado">
            {{ estado }}
          </option>
        </select>
      </div>

      <div class="filtro-actions">
        <button (click)="aplicarFiltros()" class="btn btn-secondary">Filtrar</button>
        <button (click)="limpiarFiltros()" class="btn btn-outline">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    Cargando dispositivos...
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error">
    {{ error }}
    <button (click)="cargarDispositivos()" class="btn btn-danger" style="margin-top: 10px;">
       Reintentar
    </button>
  </div>

  <!-- Tabla de dispositivos -->
  <div *ngIf="!loading && !error" class="tabla-container">
    <table class="dispositivos-table">
      <thead>
        <tr>
          <th>C贸digo</th>
          <th>Nombre</th>
          <th>Categor铆a</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Condici贸n</th>
          <th>Ubicaci贸n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let dispositivo of dispositivos">
          <td>{{ dispositivo.CodigoDispositivo || dispositivo.codigoDispositivo }}</td>
          <td>{{ dispositivo.NombreDispositivo || dispositivo.nombreDispositivo }}</td>
          <td>{{ dispositivo.NombreCategoria || dispositivo.nombreCategoria || 'N/A' }}</td>
          <td>{{ dispositivo.NombreMarca || dispositivo.nombreMarca || 'N/A' }}</td>
          <td>{{ dispositivo.Modelo || dispositivo.modelo || 'N/A' }}</td>
          <td>
            <span class="estado-badge" [ngClass]="getEstadoClass(dispositivo.Estado || dispositivo.estado || '')">
              {{ dispositivo.Estado || dispositivo.estado }}
            </span>
          </td>
          <td>
            <span class="condicion-badge" [ngClass]="getCondicionClass(dispositivo.Condicion || dispositivo.condicion || '')">
              {{ dispositivo.Condicion || dispositivo.condicion }}
            </span>
          </td>
          <td>{{ dispositivo.NombreUbicacion || dispositivo.nombreUbicacion || 'Sin ubicaci贸n' }}</td>
            <td class="acciones">
            <button (click)="verDispositivo(dispositivo)" class="btn btn-sm btn-info">Ver</button>
            <button *ngIf="esTecnicoOSuperior" (click)="editarDispositivo(dispositivo)" 
                    class="btn btn-sm btn-warning">Editar</button>
            <button *ngIf="esAdmin" (click)="eliminarDispositivo(dispositivo)" 
                    class="btn btn-sm btn-danger">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Mensaje cuando no hay datos -->
    <div *ngIf="dispositivos.length === 0" class="no-data">
      No se encontraron dispositivos con los filtros aplicados.
    </div>
  </div>

  <!-- Paginaci贸n -->
  <div *ngIf="paginacion.totalPaginas > 1" class="paginacion">
    <button (click)="cambiarPagina(paginacion.paginaActual - 1)" 
            [disabled]="!paginacion.tieneAnterior" class="btn btn-outline">
      Anterior
    </button>
    
    <span class="pagina-info">
      P谩gina {{ paginacion.paginaActual }} de {{ paginacion.totalPaginas }}
      ({{ paginacion.totalRegistros }} registros)
    </span>
    
    <button (click)="cambiarPagina(paginacion.paginaActual + 1)" 
            [disabled]="!paginacion.tieneSiguiente" class="btn btn-outline">
      Siguiente
    </button>
  </div>
</div>

<!-- Modal para crear/editar -->
<div *ngIf="mostrarModal" class="modal-overlay" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editando ? 'Editar' : 'Nuevo' }} Dispositivo</h2>
      <button (click)="cerrarModal()" class="close-btn">&times;</button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="guardarDispositivo()">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre del Dispositivo *</label>
            <input type="text" [(ngModel)]="dispositivoActual.nombreDispositivo" 
                   name="nombreDispositivo" required>
          </div>
          
          <div class="form-group">
            <label>Categor铆a *</label>
            <select [(ngModel)]="dispositivoActual.categoriaId" name="categoriaId" required>
              <option value="">Seleccionar categor铆a</option>
              <option *ngFor="let cat of categorias" [value]="cat.CategoriaID || cat.categoriaID">
                {{ cat.NombreCategoria || cat.nombreCategoria }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Marca *</label>
            <select [(ngModel)]="dispositivoActual.marcaId" name="marcaId" required>
              <option value="">Seleccionar marca</option>
              <option *ngFor="let marca of marcas" [value]="marca.MarcaID || marca.marcaID">
                {{ marca.NombreMarca || marca.nombreMarca }}
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Modelo *</label>
            <input type="text" [(ngModel)]="dispositivoActual.modelo" name="modelo" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>N煤mero de Serie</label>
            <input type="text" [(ngModel)]="dispositivoActual.numeroSerie" name="numeroSerie">
          </div>
          
          <div class="form-group">
            <label>N煤mero de Parte</label>
            <input type="text" [(ngModel)]="dispositivoActual.numeroParte" name="numeroParte">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Estado</label>
            <select [(ngModel)]="dispositivoActual.estado" name="estado">
              <option *ngFor="let estado of estados" [value]="estado">
                {{ estado }}
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Condici贸n</label>
            <select [(ngModel)]="dispositivoActual.condicion" name="condicion">
              <option *ngFor="let condicion of condiciones" [value]="condicion">
                {{ condicion }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Ubicaci贸n</label>
            <select [(ngModel)]="dispositivoActual.ubicacionId" name="ubicacionId">
              <option value="">Sin ubicaci贸n</option>
              <option *ngFor="let ubicacion of ubicaciones" [value]="ubicacion.UbicacionID || ubicacion.ubicacionID">
                {{ ubicacion.NombreUbicacion || ubicacion.nombreUbicacion }}
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Precio de Compra</label>
            <input type="number" [(ngModel)]="dispositivoActual.precioCompra" 
                   name="precioCompra" step="0.01" min="0">
          </div>
        </div>

        <div class="form-group">
          <label>Observaciones</label>
          <textarea [(ngModel)]="dispositivoActual.observaciones" name="observaciones" 
                    rows="3" placeholder="Observaciones adicionales..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" (click)="cerrarModal()" class="btn btn-outline">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            {{ editando ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>